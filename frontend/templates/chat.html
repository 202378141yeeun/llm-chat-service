<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #888;
            margin: 5px 10px 0;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 10px 20px;
            color: #888;
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .welcome-message {
            text-align: center;
            color: #888;
            padding: 40px 20px;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 95%;
                height: 95vh;
                border-radius: 10px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ğŸ¤– LLM Chat Service
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="typing-dots"></span>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    maxlength="1000"
                >
                <button class="send-button" id="sendButton">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ========================================
         * LLM Chat Service - Frontend JavaScript
         * ========================================
         * 
         * ì´ íŒŒì¼ì€ ì±„íŒ… UIì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
         * ë°±ì—”ë“œ ê°œë°œìëŠ” ì•„ë˜ API ëª…ì„¸ë¥¼ ì°¸ê³ í•˜ì—¬ ê°œë°œí•´ì£¼ì„¸ìš”.
         * 
         * API ì—”ë“œí¬ì¸íŠ¸: /api/chat
         * ë©”ì†Œë“œ: POST
         * ìš”ì²­ í˜•ì‹: { "message": "ì‚¬ìš©ì ë©”ì‹œì§€", "session_id": "ì„¸ì…˜ID" }
         * ì‘ë‹µ í˜•ì‹: { "response": "AI ì‘ë‹µ", "status": "success", "session_id": "ì„¸ì…˜ID" }
         */

        // ========================================
        // ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
        // ========================================
        
        // DOM ìš”ì†Œë“¤ - ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ì˜ í•µì‹¬ ìš”ì†Œë“¤
        const chatMessages = document.getElementById('chatMessages');     // ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­
        const chatInput = document.getElementById('chatInput');           // ì‚¬ìš©ì ì…ë ¥ í•„ë“œ
        const sendButton = document.getElementById('sendButton');         // ì „ì†¡ ë²„íŠ¼
        const typingIndicator = document.getElementById('typingIndicator'); // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
        
        // ì±„íŒ… ì„¸ì…˜ ê´€ë¦¬
        let sessionId = generateSessionId();  // ì„¸ì…˜ ID ìƒì„±
        let messageHistory = [];              // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì €ì¥
        let isProcessing = false;             // ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ìƒíƒœ
        
        // API ì„¤ì •
        const API_CONFIG = {
            BASE_URL: '/api',           // ë°±ì—”ë“œ API ê¸°ë³¸ URL
            CHAT_ENDPOINT: '/chat',     // ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸
            TIMEOUT: 30000             // ìš”ì²­ íƒ€ì„ì•„ì›ƒ (30ì´ˆ)
        };

        // ========================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ========================================
        
        /**
         * ì„¸ì…˜ ID ìƒì„± í•¨ìˆ˜
         * @returns {string} ê³ ìœ í•œ ì„¸ì…˜ ID
         */
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        /**
         * í˜„ì¬ ì‹œê°„ì„ í¬ë§·íŒ…í•˜ì—¬ ë°˜í™˜
         * @returns {string} í¬ë§·ëœ ì‹œê°„ ë¬¸ìì—´ (HH:MM)
         */
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        /**
         * HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
         * @param {string} text - ì´ìŠ¤ì¼€ì´í”„í•  í…ìŠ¤íŠ¸
         * @returns {string} ì´ìŠ¤ì¼€ì´í”„ëœ í…ìŠ¤íŠ¸
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // UI ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ========================================
        
        /**
         * ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         * @param {string} content - ë©”ì‹œì§€ ë‚´ìš©
         * @param {boolean} isUser - ì‚¬ìš©ì ë©”ì‹œì§€ ì—¬ë¶€ (true: ì‚¬ìš©ì, false: AI)
         * @param {string} messageId - ë©”ì‹œì§€ ê³ ìœ  ID (ì„ íƒì‚¬í•­)
         */
        function addMessage(content, isUser = false, messageId = null) {
            // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            // ë©”ì‹œì§€ ID ì„¤ì • (ë‚˜ì¤‘ì— ë©”ì‹œì§€ ìˆ˜ì •/ì‚­ì œ ì‹œ ì‚¬ìš©)
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }
            
            // ë©”ì‹œì§€ ë‚´ìš©ê³¼ ì‹œê°„ ì¶”ê°€
            const timeString = getCurrentTime();
            const escapedContent = escapeHtml(content);
            
            messageDiv.innerHTML = `
                <div class="message-bubble">${escapedContent}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            // í™˜ì˜ ë©”ì‹œì§€ ì œê±° (ì²« ë©”ì‹œì§€ ì‹œ)
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // ë©”ì‹œì§€ë¥¼ ì±„íŒ… ì˜ì—­ì— ì¶”ê°€
            chatMessages.appendChild(messageDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
            scrollToBottom();
            
            // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ì— ì €ì¥
            messageHistory.push({
                id: messageId || Date.now(),
                content: content,
                isUser: isUser,
                timestamp: new Date().toISOString()
            });
        }
        
        /**
         * ì±„íŒ… ì˜ì—­ì„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
         */
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        /**
         * íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
         * @param {boolean} show - í‘œì‹œ ì—¬ë¶€
         */
        function showTypingIndicator(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
            if (show) {
                scrollToBottom();
            }
        }
        
        /**
         * ì „ì†¡ ë²„íŠ¼ ë° ì…ë ¥ í•„ë“œ ìƒíƒœ ì œì–´
         * @param {boolean} disabled - ë¹„í™œì„±í™” ì—¬ë¶€
         */
        function setInputState(disabled) {
            sendButton.disabled = disabled;
            chatInput.disabled = disabled;
            isProcessing = disabled;
        }
        
        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
         * @param {string} errorMessage - ì—ëŸ¬ ë©”ì‹œì§€
         */
        function showError(errorMessage) {
            addMessage(`âŒ ${errorMessage}`, false);
        }

        // ========================================
        // ë°±ì—”ë“œ í†µì‹  í•¨ìˆ˜ë“¤
        // ========================================
        
        /**
         * ë°±ì—”ë“œ APIë¡œ ë©”ì‹œì§€ ì „ì†¡
         * ë°±ì—”ë“œ ê°œë°œì ì°¸ê³ ì‚¬í•­:
         * - ì—”ë“œí¬ì¸íŠ¸: POST /api/chat
         * - ìš”ì²­ í—¤ë”: Content-Type: application/json
         * - ìš”ì²­ ë³¸ë¬¸: { "message": string, "session_id": string }
         * - ì‘ë‹µ í˜•ì‹: { "response": string, "status": string, "session_id": string }
         * 
         * @param {string} message - ì‚¬ìš©ì ë©”ì‹œì§€
         * @returns {Promise<string>} AI ì‘ë‹µ ë©”ì‹œì§€
         */
        async function sendToBackend(message) {
            try {
                // API ìš”ì²­ ì„¤ì •
                const requestBody = {
                    message: message,
                    session_id: sessionId
                };
                
                console.log('ë°±ì—”ë“œë¡œ ì „ì†¡:', requestBody);
                
                // ë°±ì—”ë“œ API í˜¸ì¶œ
                const response = await fetch(API_CONFIG.BASE_URL + API_CONFIG.CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    // íƒ€ì„ì•„ì›ƒ ì„¤ì •
                    signal: AbortSignal.timeout(API_CONFIG.TIMEOUT)
                });
                
                // ì‘ë‹µ ìƒíƒœ í™•ì¸
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // JSON ì‘ë‹µ íŒŒì‹±
                const data = await response.json();
                console.log('ë°±ì—”ë“œ ì‘ë‹µ:', data);
                
                // ì‘ë‹µ ë°ì´í„° ê²€ì¦
                if (!data.response) {
                    throw new Error('ì‘ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
                if (data.session_id) {
                    sessionId = data.session_id;
                }
                
                return data.response;
                
            } catch (error) {
                console.error('ë°±ì—”ë“œ í†µì‹  ì˜¤ë¥˜:', error);
                
                // ì—ëŸ¬ íƒ€ì…ë³„ ì²˜ë¦¬
                if (error.name === 'AbortError') {
                    throw new Error('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (error.message.includes('HTTP 404')) {
                    throw new Error('API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else if (error.message.includes('HTTP 500')) {
                    throw new Error('ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error('ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ========================================
        // ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        // ========================================
        
        /**
         * ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡ ë° AI ì‘ë‹µ ì²˜ë¦¬
         * ì´ í•¨ìˆ˜ê°€ ì „ì²´ ì±„íŒ… í”Œë¡œìš°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
         */
        async function sendMessage() {
            // ì…ë ¥ê°’ ê²€ì¦
            const message = chatInput.value.trim();
            if (!message || isProcessing) {
                return;
            }
            
            try {
                // 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
                addMessage(message, true);
                
                // 2. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° UI ìƒíƒœ ë³€ê²½
                chatInput.value = '';
                setInputState(true);
                showTypingIndicator(true);
                
                // 3. ë°±ì—”ë“œë¡œ ë©”ì‹œì§€ ì „ì†¡ ë° ì‘ë‹µ ë°›ê¸°
                const aiResponse = await sendToBackend(message);
                
                // 4. AI ì‘ë‹µ í™”ë©´ì— í‘œì‹œ
                addMessage(aiResponse, false);
                
            } catch (error) {
                // ì—ëŸ¬ ë°œìƒ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                showError(error.message);
                
            } finally {
                // 5. UI ìƒíƒœ ë³µì›
                showTypingIndicator(false);
                setInputState(false);
                chatInput.focus();
            }
        }
        
        /**
         * ì±„íŒ… íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
         */
        function clearChat() {
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                </div>
            `;
            messageHistory = [];
            sessionId = generateSessionId();
        }

        // ========================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        // ========================================
        
        // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        sendButton.addEventListener('click', sendMessage);
        
        // Enter í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ (ìë™ ìŠ¤í¬ë¡¤)
        chatInput.addEventListener('focus', () => {
            setTimeout(scrollToBottom, 100);
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            chatInput.focus();
            console.log('ì±„íŒ… ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
            console.log('ì„¸ì…˜ ID:', sessionId);
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ì‘ì—…
        window.addEventListener('beforeunload', () => {
            // í•„ìš”ì‹œ ì„¸ì…˜ ì¢…ë£Œ API í˜¸ì¶œ
            console.log('ì±„íŒ… ì„¸ì…˜ ì¢…ë£Œ:', sessionId);
        });

        // ========================================
        // ê°œë°œìš© í•¨ìˆ˜ë“¤ (ë°°í¬ ì‹œ ì œê±° ê°€ëŠ¥)
        // ========================================
        
        /**
         * ê°œë°œìš©: ì±„íŒ… íˆìŠ¤í† ë¦¬ ì¶œë ¥
         */
        function debugPrintHistory() {
            console.log('ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬:', messageHistory);
        }
        
        /**
         * ê°œë°œìš©: í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
         */
        function debugAddTestMessage() {
            addMessage('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.', false);
        }
        
        // ê°œë°œ ëª¨ë“œì—ì„œë§Œ ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.debugChat = {
                printHistory: debugPrintHistory,
                addTestMessage: debugAddTestMessage,
                clearChat: clearChat,
                sessionId: () => sessionId
            };
        }
    </script>
</body>
</html>